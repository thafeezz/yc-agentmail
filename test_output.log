
================================================================================
API ROUTE TEST: EXPEDIA BOOKING WITH BROWSER AUTOMATION
================================================================================

This test will:
1. Create test users with Expedia credentials
2. Create an approved travel plan in the database
3. Call the API route that triggers parallel bookings
4. Verify that browser automation actually runs

âš ï¸  Requirements:
   - BROWSER_USE_API_KEY in .env
   - OPENAI_API_KEY in .env
   - AGENTMAIL_API_KEY in .env
   - Test credentials: testuser@agentmail.to / TestPass123!

â±ï¸  Expected duration: 5-15 minutes if browser automation works
================================================================================

ğŸš€ Starting test automatically in 3 seconds...
   (Press Ctrl+C to cancel)

================================================================================
TEST: API Route for Expedia Booking with Browser Automation
================================================================================
INFO     [browser_use.telemetry.service] Anonymized telemetry enabled. See https://docs.browser-use.com/development/telemetry for more information.
âœ… Combined 32 Expedia tools from all registries
âœ… Custom Expedia tools loaded
âœ… Group Chat Agent endpoints loaded

ğŸ“¦ Setting up test database...
   âœ… Cleaned up existing test data

ğŸ‘¥ Creating test users with booking credentials...
   âœ… Created test users: api_test_alice, api_test_bob

âœˆï¸  Creating approved travel plan...
   âœ… Created approved session: api_test_20251101_133843
      Location: Cancun, Mexico
      Dates: 2025-12-31 â†’ 2026-01-07
      Users: api_test_alice, api_test_bob

ğŸš€ Testing API route: POST /trigger-bookings/{session_id}
   âš ï¸  This will trigger REAL browser automation via ExpediaAgent
   âš ï¸  Expected duration: 5-15 minutes for parallel bookings
   âš ï¸  Watch at: https://cloud.browser-use.com/dashboard

â³ Calling trigger_parallel_bookings()...
   This should initialize ExpediaAgent and start browser automation...
ğŸš€ Starting parallel bookings for 2 users...

ğŸ” Booking for user api_test_alice (alice@agentmail.to)...
   Has expedia_credentials: True
   Has payment_details: True
   Has contact_info: True
âœ… api_test_alice: All credentials present, setting up AgentMail inbox...
ğŸ“§ api_test_alice: AgentMail inbox created: fancystrategy553@agentmail.to
âœˆï¸  api_test_alice: Initializing Flight Agent...
ğŸ¤– Using AI model: gpt-4o (OpenAI)
â˜ï¸  Browser mode: CLOUD (handles CAPTCHAs, saved logins)
â„¹ï¸  No profile ID - will use fresh cloud browser
   To save auth: https://cloud.browser-use.com/dashboard/settings?tab=profiles
ğŸ”§ Custom Expedia tools loaded (FLIGHT):
   - 14 total tools
ğŸ¨ api_test_alice: Initializing Hotel Agent...
ğŸ¤– Using AI model: gpt-4o (OpenAI)
â˜ï¸  Browser mode: CLOUD (handles CAPTCHAs, saved logins)
â„¹ï¸  No profile ID - will use fresh cloud browser
   To save auth: https://cloud.browser-use.com/dashboard/settings?tab=profiles
ğŸ”§ Custom Expedia tools loaded (HOTEL):
   - 10 total tools
ğŸ¤– api_test_alice: Agents initialized, starting booking tasks...
âœˆï¸  api_test_alice: Starting flight booking...

======================================================================
ğŸ¯ TASK: 
âš ï¸ âš ï¸ âš ï¸ CRITICAL OTP INSTRUCTION âš ï¸ âš ï¸ âš ï¸
After calling sign_in_expedia(), you will receive an OTP...
======================================================================

â˜ï¸  Cloud browser initialized
INFO     [browser_use.agent.service] ğŸ’¾ File system path: /var/folders/vt/qy6st08s5r78t707j1t3pz140000gn/T/browser_use_agent_069066fd-37e5-7492-8000-f0fccba8d3a6
INFO     [browser_use.AgentğŸ…° d3a6 on ğŸ†‚ d3a6 ğŸ…Ÿ 20] ğŸ§  Starting a browser-use agent 0.5.7 with base_model=gpt-4o +vision extraction_model=gpt-4o +file_system
ğŸ¤– Agent created
   âœ… Custom Expedia tools enabled (14 tools)
INFO     [browser_use.AgentğŸ…° d3a6 on ğŸ†‚ 13c6 ğŸ…Ÿ 20] ğŸš€ Starting task: 
âš ï¸ âš ï¸ âš ï¸ CRITICAL OTP INSTRUCTION âš ï¸ âš ï¸ âš ï¸
After calling sign_in_expedia(), you will receive an OTP code in the response.
You MUST use GENERIC BROWSER ACTIONS (input_text, click) to enter this OTP - NOT custom Expedia tools!
The custom Expedia tools DO NOT work on the OTP page. You must use basic browser input/click.

CRITICAL: YOU MUST USE THE CUSTOM EXPEDIA TOOLS PROVIDED (except for OTP entry).

YOUR AVAILABLE CUSTOM TOOLS:
1. sign_in_expedia(email="fancystrategy553@agentmail.to") - Signs in and waits for OTP
2. navigate_to_search_results(origin="LAX", destination="CUN", departure_date="2025-12-31", return_date="2026-01-07") - Goes directly to flight search results
3. sort_by_price() - Sorts flights by price
4. select_outbound_basic_fare() - Selects cheapest outbound flight
5. select_return_basic_fare() - Selects cheapest return flight
6. fill_traveler_details(first_name="Alice", last_name="Test", email="fancystrategy553@agentmail.to", phone="+1-555-111-2222") - Fills traveler info
7. click_continue_checkout() - Continues to payment
8. fill_payment_form(card_number="4111111111111111", cardholder_name="Alice Test", expiration_month="12", expiration_year="2025", cvv="123", billing_address=...) - Fills payment
9. agentmail_read_inbox(inbox_id="fancystrategy553@agentmail.to") - Reads OTP from email

EXACT WORKFLOW (follow this order):
Step 1: Call sign_in_expedia(email="fancystrategy553@agentmail.to")
        This tool will:
        - Navigate to Expedia and enter the email
        - Wait 10 seconds for email delivery
        - Automatically fetch ALL inbox messages (including spam/junk)
        - Return the messages with the OTP code included
        
Step 2: Read the OTP from the messages returned by sign_in_expedia
        - Look for the Expedia verification code (usually 6 digits like "123456")
        - The OTP will be clearly shown in the message bodies
        
Step 3: âš ï¸âš ï¸âš ï¸ MANDATORY - Enter OTP manually with GENERIC browser actions âš ï¸âš ï¸âš ï¸
        - Extract the 6-digit OTP code from the sign_in_expedia response (e.g., "984575")
        - Use GENERIC input_text() to fill "#verify-sms-one-time-passcode-input" with the OTP
        - Use GENERIC click() on the Continue button
        - DO NOT CALL: navigate_to_search_results, click_continue_checkout, fill_traveler_details, or ANY other Expedia tool yet!
        - You are still on the OTP page - you must complete OTP entry first before ANY other tools work!
        
Step 4: After successful login, call navigate_to_search_results(origin="LAX", destination="CUN", departure_date="2025-12-31", return_date="2026-01-07")

Step 5: Call sort_by_price()
Step 6: Call select_outbound_basic_fare()
Step 7: Call select_return_basic_fare()
Step 8: Call fill_traveler_details(first_name="Alice", last_name="Test", email="fancystrategy553@agentmail.to", phone="+1-555-111-2222")
Step 9: Call click_continue_checkout()
Step 10: Call fill_payment_form(...) with payment details
Step 11: Complete the booking

IMPORTANT: sign_in_expedia automatically fetches inbox messages after 10 seconds!
You do NOT need to call agentmail_read_inbox separately - the messages will be in the tool's response.

