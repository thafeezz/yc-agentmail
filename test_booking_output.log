
================================================================================
API ROUTE TEST: EXPEDIA BOOKING WITH BROWSER AUTOMATION
================================================================================

This test will:
1. Create test users with Expedia credentials
2. Create an approved travel plan in the database
3. Call the API route that triggers parallel bookings
4. Verify that browser automation actually runs

âš ï¸  Requirements:
   - BROWSER_USE_API_KEY in .env
   - OPENAI_API_KEY in .env
   - AGENTMAIL_API_KEY in .env
   - Test credentials: testuser@agentmail.to / TestPass123!

â±ï¸  Expected duration: 5-15 minutes if browser automation works
================================================================================

ğŸš€ Starting test automatically in 3 seconds...
   (Press Ctrl+C to cancel)

================================================================================
TEST: API Route for Expedia Booking with Browser Automation
================================================================================
INFO     [browser_use.telemetry.service] Anonymized telemetry enabled. See https://docs.browser-use.com/development/telemetry for more information.
âœ… Combined 31 Expedia tools from all registries
âœ… Custom Expedia tools loaded
âœ… Group Chat Agent endpoints loaded

ğŸ“¦ Setting up test database...
   âœ… Cleaned up existing test data

ğŸ‘¥ Creating test users with booking credentials...
   âœ… Created test users: api_test_alice, api_test_bob

âœˆï¸  Creating approved travel plan...
   âœ… Created approved session: api_test_20251101_123449
      Location: Cancun, Mexico
      Dates: 2025-12-31 â†’ 2026-01-07
      Users: api_test_alice, api_test_bob

ğŸš€ Testing API route: POST /trigger-bookings/{session_id}
   âš ï¸  This will trigger REAL browser automation via ExpediaAgent
   âš ï¸  Expected duration: 5-15 minutes for parallel bookings
   âš ï¸  Watch at: https://cloud.browser-use.com/dashboard

â³ Calling trigger_parallel_bookings()...
   This should initialize ExpediaAgent and start browser automation...
ğŸš€ Starting parallel bookings for 2 users...

ğŸ” Booking for user api_test_alice (alice@agentmail.to)...
   Has expedia_credentials: True
   Has payment_details: True
   Has contact_info: True
âœ… api_test_alice: All credentials present, initializing ExpediaAgent...
ğŸ¤– Using AI model: gpt-4o (OpenAI)
â˜ï¸  Browser mode: CLOUD (handles CAPTCHAs, saved logins)
â„¹ï¸  No profile ID - will use fresh cloud browser
   To save auth: https://cloud.browser-use.com/dashboard/settings?tab=profiles
ğŸ”§ Custom Expedia tools loaded:
   - Navigation tools (4)
   - Search tools (2)
   - Filter tools (2)
   - Login tools (1)
   - Utility tools (2)
ğŸ¤– api_test_alice: Agent initialized, starting booking task...

======================================================================
ğŸ¯ TASK: 
Complete an Expedia flight and hotel booking:

1. Navigate to Expedia homepage
2. Login with email:...
======================================================================

â˜ï¸  Cloud browser initialized
INFO     [browser_use.agent.service] ğŸ’¾ File system path: /var/folders/vt/qy6st08s5r78t707j1t3pz140000gn/T/browser_use_agent_0690660d-9755-7a8d-8000-5121df279e47
INFO     [browser_use.AgentğŸ…° 9e47 on ğŸ†‚ 9e47 ğŸ…Ÿ 72] ğŸ§  Starting a browser-use agent 0.5.7 with base_model=gpt-4o +vision extraction_model=gpt-4o +file_system
ğŸ¤– Agent created
   âœ… Custom Expedia tools enabled
INFO     [browser_use.AgentğŸ…° 9e47 on ğŸ†‚ 9f4c ğŸ…Ÿ 72] ğŸš€ Starting task: 
Complete an Expedia flight and hotel booking:

1. Navigate to Expedia homepage
2. Login with email: testuser@agentmail.to
3. Search for flights:
   - From: LAX
   - To: CUN
   - Departure: 2025-12-31
   - Return: 2026-01-07
4. Select a flight (cheapest available matching preferences: Direct flight, economy class)
5. Search for hotels in Cancun Hotel Zone
   - Check-in: 2025-12-31
   - Check-out: 2026-01-07
6. Select a hotel (best rated under budget, preferences: ['beach access', 'pool', 'wifi'])
7. Fill traveler information:
   - Name: Alice Test
   - Email: testuser@agentmail.to
   - Phone: +1-555-111-2222
8. Fill payment information:
   - Card: Alice Test
   - Billing: {'street': '123 Test St', 'city': 'Los Angeles', 'state': 'CA', 'zip': '90001', 'country': 'USA'}
9. Complete the booking

Use the custom Expedia tools to efficiently complete each step.
Take screenshots at key verification points.

